---

layout: post  
title: 使用token实现在有效期内APP自动登录功能  
date: 2016-7-19 17:20:35  
tags: [程序设计]
category: 学习笔记
comments: true  

---

实现此功能的场景是在当下用户对手机APP体验要求高，并且相对安全前提的推动下诞生；当你下载了一个QQ，微信第一次进行了账号和密码的登录，你从此以后打开应用免去了你每日打开应用都要输入账号跟密码的痛苦过程，在产品体验方面来讲，这种体验更为让用户容易接受。那么，这种自动登录如何实现；

之前在APP里面接入达达配送的时候，看到他们提供的API接口里面大致有了这个一个认证的过程，自己琢磨了一下，依稀的弄出了一个类似这样的自动登录的流程；

### 一、获取token登录令牌接口（可以理解为登录接口）

这一步是需要用户使用账号和密码进行登录去获取，用户如果登录成功，那么后台返回一个token及token的失效时间，及未来如果token失效之后刷新token的令牌！

返回参数示例及说明：

```
{
  //状态位，ok表示成功
  "status": "0",  
  //申请的有效token值
  "token": "4a28d8516d42f4821e6d5782d1a79a7a",  
  //token的有效时间,单位为秒，这里设定7天有效期（604800秒）
  "expires_in": "604800", 
  //token过期情况下，用来刷新access_token值,设置30天的有效期
  "refresh_token": "8ab486662d50e6d51a5a5dd6a25c9a4b"  
}
```

说明：

 - 用户第一次进入APP，APP判断手机上是否存在token值，不存在，表明用户第一次进入APP，跳转登录界面让用户进行登录
 - 用户使用账号和密码登录成功，后台进行认证，认证成功，返回token、expires_in、refresh_token，APP需把这几个值安全保存在手机本地，便于下一次用户进入app的一些流程判断
 - 继续上一步中间插入一个小细节，后台在登录成功之后，需要把token、expires_in、refresh_token（其他附加值：如设备唯一编号、或其他密令...）保存在数据库和用户关联的表里，便于未来用户自动登录认证使用
 - 上面步骤进行完毕，APP即跳入到应用首页，用户可以完全使用APP

### 二、刷新token登录令牌接口
此接口是对第一个接口的一些弥补，token的过期时间原理上可以说是越短越安全，那么存在的问题就是token有一个过期时间，那么过期之后是不可能让用户重新输入用户名和密码来重新获取token的，那样完全违背了提升体验的初衷，相当于此功能是一个累赘了；

在token过期的情况，我们可以使用保存在手机本地的refresh_token去后台刷新一下token，重新获取一组令牌信息，覆盖掉以前保存在手机上的令牌信息，这也算是提升了一点安全性，为避免以前的令牌信息如果真落入别人之手；

此接口的请求参数可以参考以下参数：

```
{
  //用户账号，大多数APP用的是手机号登录，这里也可以是其他值，能表名是将要自动登录的用户即可
  "username": "13000000007", 
  //手机设备的唯一值
  "imei": "928347024892343",
  //刷新token的令牌
  "refresh_token": "8ab486662d50e6d51a5a5dd6a25c9a4b"  
}
```

返回参数示例及说明：

```
{
  //状态位，ok表示成功
  "status": "0",  
  //申请的有效token值
  "token": "4a28d8516d42f4821e6d5782d1a79a7a",  
  //token的有效时间,单位为秒，这里设定7天有效期（604800秒）
  "expires_in": "604800",  
  //token过期情况下，用来刷新access_token值,设置30天的有效期
  "refresh_token": "8ab486662d50e6d51a5a5dd6a25c9a4b"  
}
```

说明：
看着是不是和获取token的接口返回值一样，对，你没有看错，这确实就是和获取token的接口是一样的，把返回的这些令牌信息覆盖掉之前保存在手机上的老的令牌信息就可以了；特别是这里为了节省请求接口的次数，刷新token成功之后就可以让用户跳转到首页进行使用app了，不用再次请求其他认证token的接口了

从请求到响应之后的一系列处理流程为：
 

 - 场景是用户过了1天之后再次打开了APP，APP首先获取本地是否存在token，如存在，会去请求第三步的token认证接口，需要用到刷新token这个接口的前提必须是token认证接口的返回值表示token过期了，那么此时本接口（刷新登录令牌的接口就有了作用），这里可以使用账号、设备编号、刷新token的令牌或者你还可以自己定一些加密方案的参数一同传入后台进行认证，当后台认证此刷新令牌（refresh_token）有效且合法，那么重新生成一组令牌保存在数据库，同时返回这一组令牌到APP（这一组令牌全部都是需要重新生成，并且过期时间重新全部初始化）
 - APP同样把成功响应的一组令牌值覆盖掉以前保存在本地的令牌值
 - 成功的情况，此时，可以让用户跳转到首页让用户使用APP
 - 失败的情况，如refresh_token也过期了，这里特别说一下，一般refresh_token的过期时间是比较长的，如果连这个也过期的话，说明用户已经太久没有使用过APP了，需要让用户重新登录

### 三、token认证接口（可理解为自动登录接口）
此接口相当而言算是请求频率比较多的一个接口，他对token进行认证成功和失败有不同的处理方式；

此接口的请求参数可以参考以下参数：

```
{
  //用户账号，大多数APP用的是手机号登录，这里也可以是其他值，能表名是将要自动登录的用户即可
  "username": "13000000007",
  //手机设备的唯一值
  "imei": "928347024892343",  
  //token认证令牌
  "token": "4a28d8516d42f4821e6d5782d1a79a7a"  
}
```

返回参数示例及说明：

```
{
  "status": "0"  //响应结果，成功
}
or
{
  "status": "1"  //响应结果，token过期
}
```

说明：

 - 这里如果返回成功，可以让用户跳转到首页使用APP
 - 如果返回token过期，调用第二步的刷新token令牌的接口去重新获取令牌

